<html lang="en">
  <head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<link rel="stylesheet" type="text/css" href="../css/style.css" media="all" />
    <title>Node EEBench</title>
 <style>
.slidecontainer {
  width: 100%;
}

.slider {
  -webkit-appearance: none;
  width: 100%;
  height: 10px;
  background: #d3d3d3;
  outline: none;
  opacity: 0.7;
  -webkit-transition: .2s;
  transition: opacity .2s;
}

.slider:hover {
  opacity: 1;
}

.slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 10px;
  height: 20px;
  background: #0067a5;
  cursor: pointer;
}

.slider::-moz-range-thumb {
  width: 10px;
  height: 20px;
  background: #0067a5;
  cursor: pointer;
}

.nobr { white-space: nowrap }

table.bx { border-collapse: collapse; }

table.bo, tr.bo, th.bo, td.bo {  border: 1px solid black; border-collapse: collapse; padding-left: 10px; 
padding-right: 10px;
}

table.bo0, tr.bo0, th.bo0, td.bo0 { border: 3px solid black; border-collapse: collapse;}
table.bo1, tr.bo1, th.bo1, td.bo1 { border: 3px solid #FF8C00; border-collapse: collapse;}
table.bo2, tr.bo2, th.bo2, td.bo2 { border: 3px solid #0000FF; border-collapse: collapse;}
table.bo3, tr.bo3, th.bo3, td.bo3 { border: 3px solid #FF1493; border-collapse: collapse;}
table.bo4, tr.bo4, th.bo4, td.bo4 { border: 3px solid #008000; border-collapse: collapse;}
table.bo5, tr.bo5, th.bo5, td.bo5 { border: 3px solid #FF4500; border-collapse: collapse;}
table.bo6, tr.bo6, th.bo6, td.bo6 { border: 3px solid #4682B4; border-collapse: collapse;}
table.bo7, tr.bo7, th.bo7, td.bo7 { border: 3px solid #DC143C; border-collapse: collapse;}
table.bo8, tr.bo8, th.bo8, td.bo8 { border: 3px solid #ABABAB; border-collapse: collapse;}

table.tb, tr.tb, th.tb, td.tb { border: 3px solid black; background: #ABABAB; border-collapse: collapse;}
table.tbs, tr.tbs, th.tbs, td.tbs { border-top: 3px solid black; border-left: 3px solid black; 
border-right: 3px solid black; background: white; border-collapse: collapse;}
td.tbr:last-child { width:100%; border-bottom: 3px solid black; background: white; border-collapse: collapse;}
td.top {vertical-align: top;}

</style> 
  </head>
  
<!-- socket.io Google -->
<script src="../node_modules/socket.io/client-dist/socket.io.js"></script>
<!-- JQuery -->
<SCRIPT SRC="../scripts/jquery.js"> </SCRIPT>
<!-- Chart -->
   <script type="text/javascript" src="../Chart_2013_03_11/Chart_basic.js"></script>
<!-- FFT -->
  <script type="text/javascript" src="../FFT/dspFFT.js"></script>
<!-- Signalgenerator-->
  <body>
  <div id="headx" style="display:block">
  <div id="nheader1" style="background-color:#0067a5;color:#FFFFFF" align="right" >
     <a href="http://www.hochschule-kempten.de" style="color:#FFFFFF"> Hochschule Kempten &nbsp; &nbsp; &nbsp; </a>
  </div>
  <div id="nheader2" style="background-color:#05adb5;color:#FFFFFF" align="right" >
     <a href="http://www.hochschule-kempten.de/about-kempten-university/faculties/electrical-engineering.html?L=1" style="color:#FFFFFF">
	 Fakult&auml;t Elektrotechnik &nbsp; &nbsp; &nbsp;
  </div>
  <div id="nheader3" style="background-color:#f18700;color:#FFFFFF" align="right">
     <a href="Elektronik.html" style="background-color:#f18700;color:#FFFFFF"> 
	 Elektronik &nbsp; &nbsp; &nbsp;</a>
    <a href="http://www.hochschule-kempten.de/metanavigation/personen/detailansicht.html?typo3state=persons&lsfid=1000430" style="background-color:#f18700;color:#FFFFFF"> 
	 Fachgebiet Elektronik, Prof. Vollrath &nbsp; &nbsp; &nbsp;</a>
  </div>
  </div>
  <br>

<table class="bx" id="tabs">
<tr><td class="tbs" onclick="tabAct(0)">&nbsp;&nbsp;Configuration&nbsp;&nbsp; </td>
    <td class="tb" onclick="tabAct(1)">&nbsp;&nbsp;AWG1&nbsp;&nbsp;</td>
	<td class="tb" onclick="tabAct(2)">&nbsp;&nbsp;OSC&nbsp;&nbsp;</td>
	<td  class="tb" onclick="tabAct(3)">&nbsp;&nbsp;FFT&nbsp;&nbsp;</td>
	<td class="tb" onclick="tabAct(4)">&nbsp;&nbsp;Ramp&nbsp;Test&nbsp;INL,&nbsp;DNL&nbsp;&nbsp;</td>
	<td class="tb" onclick="tabAct(5)">&nbsp;&nbsp;Settling&nbsp;Time&nbsp;&nbsp;</td>
	<td class="tb" onclick="tabAct(6)">&nbsp;&nbsp;Power&nbsp;Supply&nbsp;&nbsp;</td>
	<td class="tb" onclick="tabAct(7)">&nbsp;&nbsp;Bodeplot&nbsp;&nbsp;</td>
	<td class="tb" onclick="tabAct(8)">&nbsp;&nbsp;Digital&nbsp;I/O&nbsp;&nbsp;</td>
	<td class="tb" onclick="tabAct(9)">&nbsp;&nbsp;Applications&nbsp;&nbsp;</td>
	<td class="tbr"> &nbsp; &nbsp; </td></tr>
</table>

<div id="tab0" class="tabX" style="display:block">
  <h2> Configuration </h2>
  <br>
  <table>
  <tr>
  <td> System: </td>
    <td>Board:</td>
	<td id="board">BASYS 3 (Raspberry Pi, MKR Wifi 1010)  Simulation</td>
  </tr>
  <tr>
  <td> System: </td>
    <td>Communication:</td>
	<td id="com">Serial over USB (Serial NodeJs, LAN over USB?, WLAN?)</td>
  </tr>
  </table>
  <table>
  <tr>
    <td>OSC1:</td><td> XADC1 (12 Bit, 100 MHz)</td>
    <td>OSC2:</td><td> XADC2 (12 Bit, 100 MHz)</td>
    <td>OSC3:</td><td> XADC3 (12 Bit, 100 MHz)</td>
    <td>OSC4:</td><td> XADC4 (12 Bit, 100 MHz)</td>
  </tr>
  <tr>
    <td>AWG1:</td><td> R2R (16 Bit)</td>
    <td>AWG2:</td><td> None</td>
  </tr>
  <tr>
  <td> AWG1: </td>
    <td>Minimum voltage:</td>
	<td id="AWG1MinV"><input type="text" value="0 V" size="5" id="AWG1MinVVal" onkeyup=""/></td>
    <td>Maximum voltage:</td><td id="AWG1MaxV"><input type="text" value="3.3 V" size="5" id="AWG1MaxVVal" onkeyup=""/></td>
    <td>Resolution:</td><td id="AWG1Res"><input type="text" value="16" size="5" id="AWG1ResVal" onkeyup=""/> Bits</td>
  </tr>
  <tr>
  <td colspan="7"> <img src="../ImagesS/BASYS3_V04_01.png" width="400"</td>
  </tr>
  </table>

  <span id="sCmd" onclick="sendCmdC()"><img src="ImagesS/Run.png" width="16"> Send Command  </span>
  <input type="text" value="X" size="40" id="cmdTxt"/>  <br>
  <div id="lCmd">Sent: </div>
  "X": initialize<br>
  "S": sine signal, followed by 24-hex numbers: step, amplitude, offset each 32 bit<br>
  Example f = 1 kHz, amp = 1 V, offset = 1 V as shown in AWG1: S0000A7C526C9B26C26C9B26C<br> 
  "T": triangle signal, followed by 20-hex numbers: start, stop, step (16-bit each), repeat (32 bit)<br>
  Example pulse f = 1 kHz, amp = 1 V, offset = 1 V  as shown in AWG1: T00004D924D920000C350<br> 
  Example triangle f = 1 kHz, amp = 1 V, offset = 1 V  as shown in AWG1: T00004D8A001900000040<br> 
  Example stair f = 1 kHz, amp = 1 V, offset = 1 V  as shown in AWG1: T00004D8F0F8300002710<br> 
  "U": start sending data: 514 chunks of block of data are sent: AWG, OSC1, OSC2, OSC3, OSC4; 16 bit each; 20 hex values <br>
       The first transmission has the current index stored. One extra transmission, 
	  because there can be an ongoing conversion at the current index.<br>
  "V": Connect switches to output<br>

 
</div>

<div id="tab1" class="tabX" style="display:none">
  <h2> Arbitrary Waveform Generator 1</h2>
 <table >
 <tr><td class="bo" colspan="2">
     <span id="aRun"  style="display:block" onclick="aOp('Run')"><img src="ImagesS/Run.png" width="16"> Run  </span>
	 <span id="aStop" style="display:none"  onclick="aOp('Stop')"><img src="ImagesS/Stop.png" width="16"> Stop </span> </td>
 </tr>
 <tr>
   <td class="bo" align="center" bgcolor="#99e6ff" onclick="setWave(0);" id="dc"><img src="ImagesS/DC.png" width="32"><br>DC</td>
   <td class="bo" align="center" bgcolor="#FFFFFF" onclick="setWave(1);" id="sine"><img src="ImagesS/Sine.png" width="32"><br>Sine</td>
   <td class="bo" align="center" bgcolor="#FFFFFF" onclick="setWave(2);" id="rect"><img src="ImagesS/Rect.png" width="32"><br>Pulse</td>
   <td class="bo" align="center" bgcolor="#FFFFFF"  onclick="setWave(3);" id="triangle"><img src="ImagesS/Triangle.png" width="32"><br>Triangle</td>
   <td class="bo" align="center" bgcolor="#FFFFFF"  onclick="setWave(4);" id="stair"><img src="ImagesS/Stair1.png" width="32"><br>Stair</td>
   <td rowspan="4"> <canvas id="Ausgangssignal" width="400" height="300">   </canvas></td>
 </tr>

 <tr><td colspan="5">
  <div id="frequency" class="sliderE">
  </div>
 </td>
 </tr>

 <tr><td colspan="5">
  <div id="amplitude" class="sliderE">
  </div>
 </td></tr>

 <tr><td colspan="5">
  <div id="offset1" class="sliderE">
  <table>       <!-- Slider --->
  <tr>
   <td colspan="5">
     <div id="off1" class="slidecontainer">
	   <h4>Offset </h4>                         <!--- name --->
	   <input type="range" min="0" max="100" step="2" value="1" class="slider" id="offset1Slider" width="300">
	 </div>
   </td>
  </tr>
  <tr><td>Min</td><td align="center" colspan="2">Value </td><td>Max</td></tr>
  <tr>
   <td>
   <div id="offset1MinCT" style="display:block">
   <input type="text" value="1 V" size="5" id="offset1Min" onkeyup="readCR(e,'offset1','V')"/>  
   <img src="ImagesS/SelectListA.png" width="16" height="16" onclick="comboBox('offset1','Min','CB',1,voltRange,'V')"><br>
   </div>
   <div id="offset1MinCB" style="display:none">
     <select name="offset1MinS" id="offset1MinS" >
      <option value="5 V" onclick="comboBox('offset1','Min','CT',1,voltRange,'V')"> 5 V</option>
      <option value="4 V" onclick="comboBox('offset1','Min','CT',1,voltRange,'V')"> 4 V</option>
      <option value="3 V" onclick="comboBox('offset1','Min','CT',1,voltRange,'V')"> 3 V</option>
      <option value="2 V" onclick="comboBox('offset1','Min','CT',1,voltRange,'V')"> 2 V</option>
      <option value="1 V" onclick="comboBox('offset1','Min','CT',1,voltRange,'V')"> 1 V</option>
      <option value="500 mV" onclick="comboBox('offset1','Min','CT',1,voltRange,'V')"> 500 mV</option>
      <option value="200 mV" onclick="comboBox('offset1','Min','CT',1,voltRange,'V')"> 200 mV</option>
      <option value="100 mV" onclick="comboBox('offset1','Min','CT',1,voltRange,'V')">100 mV</option>
      <option value="-100 mV" onclick="comboBox('offset1','Min','CT',1,voltRange,'V')"> -100 mV</option>
      <option value="-200 mV" onclick="comboBox('offset1','Min','CT',1,voltRange,'V')"> -200 mV</option>
      <option value="-500 mV" onclick="comboBox('offset1','Min','CT',1,voltRange,'V')"> -500 mV</option>
      <option value="-1 V" onclick="comboBox('offset1','Min','CT',1,voltRange,'V')"> -1 V</option>
      <option value="-2 V" onclick="comboBox('offset1','Min','CT',1,voltRange,'V')"> -2 V</option>
      <option value="-3 V" onclick="comboBox('offset1','Min','CT',1,voltRange,'V')"> -3 V</option>
      <option value="-4 V" onclick="comboBox('offset1','Min','CT',1,voltRange,'V')"> -4 V</option>
      <option value="-5 V" onclick="comboBox('offset1','Min','CT',1,voltRange,'V')"> -5 V</option>
     </select>
   </div>
   </td>    <!--- actual value ---->       
   <td colspan="2" align="center">
     <div id="offset1ValCT" style="display:block">
     <input type="text" value="1 V" size="5" id="offset1Val"  onkeyup="readCR(e,'offset1','V')"/>  
     <img src="ImagesS/SelectListA.png" width="16" height="16" onclick="comboBox('offset1','Val','CB',1,voltRange,'V')">
     </div>
     <div id="offset1ValCB" style="display:none">
      <select name="offset1ValS" id="offset1ValS">
       <option value="5 V" onclick="comboBox('offset1','Val','CT',1,voltRange,'V')"> 5 V</option>
       <option value="4 V" onclick="comboBox('offset1','Val','CT',1,voltRange,'V')"> 4 V</option>
       <option value="3 V" onclick="comboBox('offset1','Val','CT',1,voltRange,'V')"> 3 V</option>
       <option value="2 V" onclick="comboBox('offset1','Val','CT',1,voltRange,'V')"> 2 V</option>
       <option value="1 V" selected onclick="comboBox('offset1','Val','CT',1,voltRange,'V')"> 1 V</option>
       <option value="500 mV" onclick="comboBox('offset1','Val','CT',1,voltRange,'V')"> 500 mV</option>
       <option value="200 mV" onclick="comboBox('offset1','Val','CT',1,voltRange,'V')"> 200 mV</option>
       <option value="100 mV" onclick="comboBox('offset1','Val','CT',1,voltRange,'V')">100 mV</option>
       <option value="-100 mV" onclick="comboBox('offset1','Val','CT',1,voltRange,'V')"> -100 mV</option>
       <option value="-200 mV" onclick="comboBox('offset1','Val','CT',1,voltRange,'V')"> -200 mV</option>
       <option value="-500 mV" onclick="comboBox('offset1','Val','CT',1,voltRange,'V')"> -500 mV</option>
       <option value="-1 V" onclick="comboBox('offset1','Val','CT',1,voltRange,'V')"> -1 V</option>
       <option value="-2 V" onclick="comboBox('offset1','Val','CT',1,voltRange,'V')"> -2 V</option>
       <option value="-3 V" onclick="comboBox('offset1','Val','CT',1,voltRange,'V')"> -3 V</option>
       <option value="-4 V" onclick="comboBox('offset1','Val','CT',1,voltRange,'V')"> -4 V</option>
       <option value="-5 V" onclick="comboBox('offset1','Val','CT',1,voltRange,'V')"> -5 V</option>
      </select>
     </div>
   </td>
   <td>  
     <div id="offset1MaxCT" style="display:block">
     <input type="text" value="1 V" size="5" id="offset1Max"  onkeyup="readCR(e,'offset1','V')"/>  
     <img src="ImagesS/SelectListA.png" width="16" height="16" onclick="comboBox('offset1','Max','CB',1,voltRange,'V')"><br>
     </div>
     <div id="offset1MaxCB" style="display:none">
      <select name="offset1MaxS" id="offset1MaxS">
       <option value="5 V" onclick="comboBox('offset1','Max','CT',1,voltRange,'V')"> 5 V</option>
       <option value="4 V" onclick="comboBox('offset1','Max','CT',1,voltRange,'V')"> 4 V</option>
       <option value="3 V" onclick="comboBox('offset1','Max','CT',1,voltRange,'V')"> 3 V</option>
       <option value="2 V" onclick="comboBox('offset1','Max','CT',1,voltRange,'V')"> 2 V</option>
       <option value="1 V" selected onclick="comboBox('offset1','Max','CT',1,voltRange,'V')"> 1 V</option>
       <option value="500 mV" onclick="comboBox('offset1','Max','CT',1,voltRange,'V')"> 500 mV</option>
       <option value="200 mV" onclick="comboBox('offset1','Max','CT',1,voltRange,'V')"> 200 mV</option>
       <option value="100 mV" onclick="comboBox('offset1','Max','CT',1,voltRange,'V')">100 mV</option>
       <option value="-100 mV" onclick="comboBox('offset1','Max','CT',1,voltRange,'V')"> -100 mV</option>
       <option value="-200 mV" onclick="comboBox('offset1','Max','CT',1,voltRange,'V')"> -200 mV</option>
       <option value="-500 mV" onclick="comboBox('offset1','Max','CT',1,voltRange,'V')"> -500 mV</option>
       <option value="-1 V" onclick="comboBox('offset1','Max','CT',1,voltRange,'V')"> -1 V</option>
       <option value="-2 V" onclick="comboBox('offset1','Max','CT',1,voltRange,'V')"> -2 V</option>
       <option value="-3 V" onclick="comboBox('offset1','Max','CT',1,voltRange,'V')"> -3 V</option>
       <option value="-4 V" onclick="comboBox('offset1','Max','CT',1,voltRange,'V')"> -4 V</option>
       <option value="-5 V" onclick="comboBox('offset1','Max','CT',1,voltRange,'V')"> -5 V</option>
      </select>
     </div>
    </td>
   </tr>
   </table>
   </div>
   </td>
</tr>

</table>
<div id="cmd"></div>
Make change from V to code possible<br>
Number of periods per 64k? samples instead of frequency<br>
</div>

<div id="tab2" class="tabX" style="display:none">
  <h2> Oscilloscope</h2>
 <table class="bx">
 <tr><td class="bo" colspan="2">
     <span id="oRun"  style="display:block" onclick="oOp('Run')"><img src="ImagesS/Run.png" width="16"> Run  </span>
	 <span id="oStop" style="display:none"  onclick="oOp('Stop')"><img src="ImagesS/Stop.png" width="16"> Stop </span> </td>
 </tr>
 <tr><td class="bo">Acquisition </td><td class="bo">Average: 1</td><td class="bo">Number of samples: 256</td>
     <td class="bo"> xy  x-axis
      <select name="xyAxis" id="xyAxis" onclick="changeXAxis()">
       <option value="0" selected> Time </option>
       <option value="1"> AWG1 </option>
       <option value="2"> C1 </option>
       <option value="3"> C2 </option>
       <option value="4"> C3 </option>
       <option value="5"> C4 </option>
	  </select>
	 </td>
 </tr>
 <tr>
   <td class="bo">Trigger</td>
   <td class="bo">Source &nbsp; 
      <select name="trgSrc" id="trgSrc">
       <option value="1"> AWG1 </option>
       <option value="2"> C1 </option>
       <option value="3"> C2 </option>
       <option value="4"> C3 </option>
       <option value="5"> C4 </option>
	  </select>
   </td>
   <td class="bo">Condition &nbsp; 
      <select name="trgEdge" id="trgEdge">
       <option value="1"> Rising </option>
       <option value="2"> Falling </option>
	  </select>
   </td>
   <td class="bo"><table><tr><td>Level</td><td>
     <input type="text" value="1 V" size="5" id="trigLevelVal"></td><td>
	 <img id="trigLevelValCT" style="display:block" src="ImagesS/SelectListA.png" width="16" height="16" onclick="comboBox('trigLevel','Val','CB',0,voltRange,'V')">
	 <span id="trigLevelValCB" style="display:none">
      <select name="trigLevelValS" id="trigLevelValS">
       <option value="3 V" onclick="comboBox('trigLevel','Val','CT',0,voltRange,'V')"> 3 V</option>
       <option value="2 V" onclick="comboBox('trigLevel','Val','CT',0,voltRange,'V')"> 2 V</option>
       <option value="1 V" selected onclick="comboBox('trigLevel','Val','CT',0,voltRange,'V')"> 1 V</option>
       <option value="500 mV" onclick="comboBox('trigLevel','Val','CT',0,voltRange,'V')"> 500 mV</option>
     </select>
     </span>  </td></tr>
	 </table> 
   </td>
 </tr>
</table>
<table>
<tr>
<td>
 <table>
 <tr> <td>X Axis</td></tr>
 <tr> <td class="bo0" id="time"><input type="checkbox" id="cTime" value="value" checked> Time<br>
 	    <table><tr><td>
		  Postion: </td><td><input type="text" value="0 s" size="5" id="posVal"></td><td> 
		  <img id="posCT" style="display:block" src="ImagesS/SelectListA.png" width="16" height="16" 
		       onclick="">
          <select name="pos" id="pos" style="display:none"></select>
		  </td></tr>
		  <tr><td>Base: </td><td><input type="text" value="1 us" size="5" id="baseVal"></td><td> 
		  <img id="baseCT" style="display:block" src="ImagesS/SelectListA.png" width="16" height="16" onclick="">
          <select name="base" id="base"  style="display:none"></select>
          </td></tr>
		  </table>
 </td></tr>
 <tr> <td>=====&nbsp;Y&nbsp;Axis&nbsp;&nbsp;=========</td></tr>
 <tr> <td class="bo1" id="AWG1">
        <input type="checkbox" id="cAWG1" value="value" checked onclick="toggleCheck('AWG1',1)">
	      AWG1 Unit: 
		        <select name="unitAWG1" id="unitAWG1">
       <option value="count" onclick="changeUnit('AWG1','')">Count</option>
       <option value="V" selected onclick="changeUnit('AWG1','')">V</option>
       <option value="A" onclick="changeUnit('AWG1','')">A</option>
       <option value="O" onclick="changeUnit('AWG1','')">&Omega;</option>
       <option value="W" onclick="changeUnit('AWG1','')">W</option>
     </select>
	    <table id="tabAWG1" style="display:block"><tr><td>
		  Offset: </td><td><input type="text" value="0 V" size="5" id="offAWG1Val"></td><td> 
		  <img id="offAWG1CT" style="display:block" src="ImagesS/SelectListA.png" width="16" height="16" onclick="">
          </td></tr>
		  <tr><td>Range: </td><td><input type="text" value="0 V" size="5" id="rangeAWG1Val"></td><td> 
		  <img id="rangeAWG1CT" style="display:block" src="ImagesS/SelectListA.png" width="16" height="16" onclick="">
          </td></tr>
		  </table>
	  </td></tr>
 <tr> <td class="bo2" id="C1">
        <input type="checkbox" id="cC1" value="value">
	      C1
	  </td></tr>
 <tr> <td class="bo3" id="C2">
        <input type="checkbox" id="cC2" value="value">
	      C2</td></tr>
 <tr> <td class="bo4" id="C3">
        <input type="checkbox" id="cC3" value="value">
	      C3</td></tr>
 <tr> <td class="bo5" id="C4">
        <input type="checkbox" id="cC4" value="value">
	      C4</td></tr>
 <tr> <td class="bo6" id="M1">
        <input type="checkbox" id="cM1" value="value">
	      M1</td></tr>
 </table>
</td> 
   <td class="top" rowspan="6"> 
   <table>
   <tr><td class="bo1" onclick="activeChan(1)">AWG</td><td class="bo2" onclick="activeChan(2)">C1</td>
       <td class="bo3" onclick="activeChan(3)">C2</td><td class="bo4" onclick="activeChan(4)">C3</td>
	   <td class="bo5" onclick="activeChan(5)">C4</td><td class="bo6" onclick="activeChan(6)"> M1</td>
	   <td> <div id="statusOSC"></div></td>
   </tr>
   </table>
            <canvas id="OSC" width="600" height="350"></canvas><br>
			<span id="mouse">Mouse</span>
			</td>
<td>
 <div id="measureOSC"></div>
</td> 

</tr>
</table>
<span style="background-color:#cce6ff;" onclick="generateData()">Load data</span> save data<br>
<br>
Offset, range list<br>
connect input to chart<br>
X,Y Cursors<br>
Math function, Fit function<br>
<div id="data" style="display:none"></div>
</div>

<div id="tab3" class="tabX" style="display:none">
<h2>FFT</h2>

</div>

<div id="tab4" class="tabX" style="display:none">
<h2>Ramp Test</h2>

</div>

<div id="tab5" class="tabX" style="display:none">
<h2>Settling time</h2>
</div>

<div id="tab6" class="tabX" style="display:none">
<h2>Power supply</h2>
</div>

<div id="tab7" class="tabX" style="display:none">
<h2>Bodeplot</h2>
</div>

<div id="tab8" class="tabX" style="display:none">
<h2>Digital I/O</h2>
</div>

<div id="tab9" class="tabX" style="display:none">
<h2>Applications</h2>

IV curves: R, Diode, transistor, opamp, inverter<br>
Time operation: C, L, diode, transistor, inverter<br>
Bodeplot: passive and active Filters<br>
Power supply, SC circuits<br>
AD and DA converter<br>
Digital circuits, logic functions, multiplexer and encoder<br>
State machines, Counters, serializer and deserializer, memories<br> 
Microprocessors<br>
Digital signal processing and control loops<br>
</div>

<script>

 var srcX = ["AWG","OSC4", "OSC3","OSC2","OSC1"];
 var dataOSC = [];  // expecting 512 times 5 data points
 var dataIndex = 1;

var curveTyp = 1;
var e;      // event
var aXY = [];   // x y values AWG
var aGrN = 64;  // number of xy values AWG
var aState="Stop";
// range
var voltRange = ["5 V","4 V","3 V","2 V","1 V","900 mV", "800 mV", "700 mV", "600 mV",
                 "500 mV","400 mV","300 mV","200 mV","100 mV","80 mV","60 mV","50 mV","0 V",
				 "-50 mV","-60 mV","-80 mV","-100 mV","-200 mV","-300 mV","-400 mV","-500 mV",
				 "-600 mV","-700 mV","-800 mV","-900mV","-1 V","-2 V","-3 V","-4 V","-5 V"];
var frequencyRange = ["5 MHz","2 MHz","1 MHz","500 kHz","200 kHz","100 kHz", "50 kHz", "20 kHz", "10 kHz",
                 "5 kHz","2 kHz","1 kHz","500 Hz","200 Hz","100 Hz","50 Hz","20 Hz","10 Hz",
				 "5 Hz","2 Hz","1 Hz","500 mHz","200 mHz","100 mHz","50 mHz","20 mHz",
				 "10 mHz","5 mHz","2 mHz","1mHz","500 uHz","200 uHz","100 uHz"];

function tabAct(x) { // show only active tab
  // class tbs -> tb, x class member tb -> tbs
  var tabClass = document.getElementsByClassName("tbs");
  var tabClassDiv = document.getElementsByClassName("tabX");
  for (var i = 0; i < tabClass.length; i++) {
     tabClass[i].classList.add("tb");
     tabClass[i].classList.remove("tbs");
  }
  for (var i = 0; i < tabClassDiv.length; i++) {
	 tabClassDiv[i].style.display = "none";
  }
  // alert(x + "," + tabClass.length);
  tabClass = document.getElementsByClassName("tb");
  // alert(x + "," + tabClass.length);
  tabClass[x].classList.add("tbs");
  tabClass[x].classList.remove("tb");
  tabClassDiv[x].style.display = "block";

}

function aOp(cmd) {  // AWG operation
  if (cmd == "Run") {
    document.getElementById("aStop").style.display="block";
    document.getElementById("aRun").style.display="none";
	// Action missing
    sendCmd();
	aState = "Run";
  } else {
    var cmdTemp =  document.getElementById("cmd").innerHTML;
    document.getElementById("cmd").innerHTML ="X";
    document.getElementById("aRun").style.display="block";
    document.getElementById("aStop").style.display="none";
	// Action missing
	sendCmd();
	document.getElementById("cmd").innerHTML = cmdTemp;
	aState = "Stop";
  }
}

var handlerOsc;
var busyOsc = 0;

function runOsc() {
   if (busyOsc == 0 ) {
     document.getElementById("cmd").innerHTML ="U";   // send command to send data
	 sendCmd();
	 busyOsc = 1;  // new data going on
   }	
}

function oOp(cmd) {  // oscilloscope reading
  var cmdTemp =  document.getElementById("cmd").innerHTML;
  if (cmd == "Run") {
    document.getElementById("cmd").innerHTML ="U";   // send command to send data
    document.getElementById("oStop").style.display="block";
    document.getElementById("oRun").style.display="none";
	// Action 
	sendCmd();
	oState = "Run";
	dataIndex = 0;
	handlerOsc = setInterval(runOsc,1000);
  } else {
    // document.getElementById("cmd").innerHTML ="X";
    document.getElementById("oRun").style.display="block";
    document.getElementById("oStop").style.display="none";
	// Action
	// sendCmd();
	oState = "Stop";
	clearInterval(handlerOsc);
  }
  document.getElementById("cmd").innerHTML = cmdTemp;
}

function readCR(key,id,unit) {
	if (!key) {	key = event; key.which = key.keyCode; }
	if (key.which == 13) { updateSlider(id,unit);}
}

function setWave(nr) {
  // alert(nr);
  var wNames = ["dc","sine","rect","triangle","stair"];
  curveTyp = nr;
  for (var i = 0; i < wNames.length; i++) {
     if (i == nr) {
       document.getElementById(wNames[i]).style.backgroundColor = "#99e6ff";
	 } else {
       document.getElementById(wNames[i]).style.backgroundColor = "#FFFFFF";
     }	 
  }
  // Missing disable Frequency Amplitude for DC
  plotAWG();
}


// Makes a text input with arrow with list id=offset1Min, offset2Min 
function comboBox(id,minmax,nr,slider,unit) {
  if (nr == "CT") {    // activate text input
    document.getElementById(id + minmax + "CT").style.display="block";
    document.getElementById(id + minmax + "CB").style.display="none";
	// change selected value in List 
	document.getElementById(id + minmax).value = document.getElementById(id + minmax + "S").value; 
  } else {          // activate List
    document.getElementById(id + minmax + "CT").style.display="none";
    document.getElementById(id + minmax + "CB").style.display="block";
	// change value in text input 
	var valX = findNextOption(id + minmax + "S",document.getElementById(id + minmax).value);
	document.getElementById(id + minmax + "S").value = valX;  
	document.getElementById(id + "Val").value = valX;
  }
  if (slider == 1) { updateSlider(id,unit); }
}

function unitToValue(txtV) {
  var text = txtV.split(" ");  // number and unit
  // alert("x" + txtV + "x");
  var scale = 1;
  if (text.length == 0) {
    text[0] = "0";
  } else if (text.length > 1) {
    var unit = text[1].substring(0,1); // get unit
    if (unit == "T") { scale = 1E12; }
    else if (unit == "G") { scale = 1E9; }
    else if (unit == "M") { scale = 1E6; }
    else if (unit == "k") { scale = 1E3; }
    else if (unit == "m") { scale = 1E-3; }
    else if (unit == "u") { scale = 1E-6; }
    else if (unit == "n") { scale = 1E-9; }
    else if (unit == "p") { scale = 1E-12; }
  }
  return parseFloat(text[0])*scale;
}

function valueToUnit(val) {
    var valabs = Math.abs(val);
	var scale = 1;
	var mod ="";
    if (valabs >= 1E12) { mod = "T"; scale = 1E12; }
    else if (valabs >= 1E9) { mod = "G"; scale = 1E-9; }
    else if (valabs >= 1E6) { mod = "M"; scale = 1E-6; }
    else if (valabs >= 1E3) { mod = "k"; scale = 1E-3; }
    else if (valabs >= 1) { mod = ""; scale = 1; }
    else if (valabs >= 1E-3) { mod = "m"; scale = 1E3; }
    else if (valabs >= 1E-6) { mod = "u"; scale = 1E6; }
    else if (valabs >= 1E-9) { mod = "n"; scale = 1E9; }
    else { mod = "p"; scale = 1E12; }
    return (val*scale).toPrecision(3) + " " + mod;
}

function findNextOption(optionId,valueU) {
  var selectBoxEl = document.getElementById(optionId);
  var arrayOfNodes = selectBoxEl.childNodes;
  var optionsArr = [];
  // loop through child Nodes and only get option nodes
  for (var i = 0; i < arrayOfNodes.length; i++) {
	if (arrayOfNodes[i].nodeName === 'OPTION') {
  	  optionsArr.push(arrayOfNodes[i].value);
    }
  }
  // alert(optionsArr);
  var select = optionsArr[0];
  var delta = Math.abs(unitToValue(optionsArr[0]) - unitToValue(valueU) );
  for (var i = 1; i < optionsArr.length; i++) {
     var delta1 = Math.abs(unitToValue(optionsArr[i]) - unitToValue(valueU) );
	 if (delta1 < delta) {
	    select = optionsArr[i];
		delta = delta1;
	 }
  }
  return select;
}

function updateSlider(id,unit) { // From Min Value Max list limit Value
    // Min update slider
	var minXE = unitToValue(document.getElementById(id+"Min").value);
	// alert(minXE);
	document.getElementById(id+"Slider").min = minXE
    // Max update slider
	var maxXE = unitToValue(document.getElementById(id+"Max").value);
	if (maxXE < minXE) {   // Max greater than Min
	    maxXE = minXE; 
		document.getElementById(id+"Max").value = valueToUnit(maxXE) + unit;
	}
	document.getElementById(id+"Slider").max = maxXE
    // Step
	document.getElementById(id+"Slider").step = (maxXE - minXE)/50;
	// value
	var val = unitToValue(document.getElementById(id + "Val").value);
	document.getElementById(id + "Slider").value = val;
	if (val > maxXE) { val = maxXE; }
	if (val < minXE) { val = minXE; }
    // position	
	document.getElementById(id + "Slider").value = val;
	document.getElementById(id + "Val").value = valueToUnit(val) + unit;
	// update curve
	plotAWG();
}

function slider(id,unit) {
var dslider = document.getElementById(id+"Slider");		//Slider
var d = document.getElementById(id + "Val");
  d.value = valueToUnit(dslider.value) + unit;          // update Value
  dslider.oninput = function(){
	d.value = valueToUnit(this.value) + unit;
	// update graph
    plotAWG();
  }
}


function createSlider(id,range,unit) { // Misisng unit V HZ and range name function comboBox readCR
var xList = ["Min","Val","Max"];
var nSlider = document.getElementById(id);		// create Slider with min, value max
var innerTxt = "<table>\n"      
             + " <tr>"
             + "<td colspan='4'>"       
	         + "<div id='off1' class='slidecontainer'>"
	         + "<h4>" + id[0].toUpperCase() + id.substring(1) + "</h4>"
	         + '<input type="range" min="' + unitToValue(range[range.length - 1]) + '" max="' + unitToValue(range[0]) 
			 + '" step="2" value="' + unitToValue(range[Math.trunc(range.length/2)]) + '" class="slider" id="' + id + 'Slider" width="300">'
	         + '</div>'
             + '</td>'
             + '</tr>'
             +' <tr><td>Min</td><td align="center">Value </td><td>Max</td></tr>'
             + '<tr>';
	for (var j = 0; j < xList.length; j++) {
      var valX = range[range.length - 1];
	  if (xList[j] == "Val") valX = range[Math.trunc(range.length/2)];
	  if (xList[j] == "Max") valX = range[0];
      innerTxt = innerTxt + '<td>'
             + '<div id="' + id + xList[j] +'CT" style="display:block">'
             + '<input type="text" value="' + valX + '" size="5" id="' + id + xList[j] + '" onkeyup="readCR(e,' + "'" + id +"','" + unit + "'" +')"/>\n'  
             + '<img src="ImagesS/SelectListA.png" width="16" height="16" onclick="comboBox(' + "'" + id + "'" + ',' + "'" 
			  + xList[j] + "'" +','+ "'" + 'CB' + "'" +',1,voltRange,'+ "'" + unit + "'" + ')">'
             + '</div>'
             + '<div id="' + id + xList[j] + 'CB" style="display:none">'
             + '<select name="' + id + xList[j] + 'S" id="' + id + xList[j] + 'S" >';
      for (var i = 0; i < range.length; i++) {
         innerTxt +='<option value="' + range[i] + '" onclick="comboBox('+ "'" + id + "','" 
	               + xList[j] + "','"+'CT' + "',1,voltRange,'" + unit + "')" +'">' + range[i] + '</option>';
      }			 // Value combo box
      innerTxt = innerTxt + '</select>'
             + '</div>'
             + '</td>';       
    }
    innerTxt = innerTxt + '</tr></table>'
	nSlider.innerHTML = innerTxt;
}

function createComboBox(id,range,unit) {
var nCombo = document.getElementById(id);		// create Slider with min, value max
var valX = range[range.length - 1];

var innerTxt = "<table>\n"      
             + " <tr>"
             + '</tr>';
    innerTxt = innerTxt + '<td>'
             + '<div id="' + id +'ValCT" style="display:block">'
             + '<input type="text" value="' + valX + '" size="5" id="' + id + 'Val" onkeyup="readCR(e,' + "'" + id +"','" + id +"'" +')"/>\n'  
             + '<img src="ImagesS/SelectListA.png" width="16" height="16" onclick="comboBox(' + "'" + id + "'" + ',' + "'" 
			 + "Val'" +','+ "'" + 'CB' + "'" +',1,voltRange,'+ "'" + unit + "'" + ')">'
             + '</div>'
             + '<div id="' + id + 'ValCB" style="display:none">'
             + '<select name="' + id + 'ValS" id="' + id + 'ValS" >';
      for (var i = 0; i < range.length; i++) {                  // create options from range
         innerTxt +='<option value="' + range[i] + '" onclick="comboBox('+ "'" + id + "','" 
	               + "Val','"+'CT' + "',1,voltRange,'" + id +"')" +'">' + range[i] + '</option>';
      }			 // Value combo box
      innerTxt = innerTxt + '</select>'
             + '</div>'
             + '</td>';       
    innerTxt = innerTxt + '</tr></table>'
	nCombo.innerHTML = innerTxt;
}

window.addEventListener("load",createSlider('amplitude',voltRange,'V'));
window.addEventListener("load",createSlider('frequency',frequencyRange,'Hz'));
window.addEventListener("load",slider('offset1','V'));
window.addEventListener("load",updateSlider('offset1','V'));
window.addEventListener("load",slider('amplitude','V'));
window.addEventListener("load",updateSlider('amplitude','V'));
window.addEventListener("load",slider('frequency','Hz'));
window.addEventListener("load",updateSlider('frequency','Hz'));
window.addEventListener("load",setWave(1));

// window.addEventListener("load",alert(findNextOption('offset1ValS','100 mV')));
function decToHex(x,d) {
   var hexN = ["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F"];
   var hex = "";
   var num = Math.round(x);
   var div;
   var rest;
   for (var i = 0; i < d; i++) {    //  8 hex digits
       div = Math.trunc(num/16);
	   rest = num % 16;
	   // alert(num +"x" + div + "x" + rest);
	   hex = hexN[rest] + hex;
	   num = div;
   }
   return hex;
}

function DecHexValue(x) {
 if (x=="A") { return 10; } else if (x=="B") {  return 11;
 } else if (x=="C") { return 12; } else if (x=="D") {  return 13;
 } else if (x=="E") {return 14; } else if (x=="F") {  return 15;
 } else { return parseInt(x); }
}

function hexToDec(x) {
   var hexN = ["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F"];
   var dec = 0;
   for (var i = 0; i < x.length; i++) {    //  8 hex digits
      dec = dec * 16 + DecHexValue(x[i]); 
   }
   return dec;
}

function genCmdAWG() {  // generate serial command for BASYS3
  var cmd = "";
  var maxV = 3.3;
  var maxC = 32767;
  var frequency = unitToValue(document.getElementById("frequencyVal").value);
  var amp = unitToValue(document.getElementById("amplitudeVal").value);
  var off = unitToValue(document.getElementById("offset1Val").value);
  var start;   // Triangle parameters
  var stop;
  var step;
  var repeat;
  var ampC;
  var offC;
	if (curveTyp == 0) {  // DC
	   cmd = "T"; // triangle 
	   start = Math.trunc(maxC / maxV * off);
       cmd = cmd + 	decToHex(start,4);   
       cmd = cmd + 	decToHex(start,4);  // stop =start DC   
       cmd = cmd + 	"0001";     
       cmd = cmd +  "00020000";  // doesn't matter
	} else if (curveTyp == 1) {  // Sine
	   cmd = "S"; // triangle 
	   ampC = Math.trunc( (2*1024*1024*1024-1) / maxV * amp);
       offC = Math.trunc( (2*1024*1024*1024-1) / maxV * off);
       if (offC >= 2*1024*1024*1024) { offC = 2*1024*1024*1024-1; }
	   if ((offC + ampC) >= 2*1024*1024*1024) { ampC = 2*1024*1024*1024-1-offC; } 	   
	   if ((offC - ampC) < 0) { ampC = offC; }
	   step = Math.trunc(1024*1024*1024/(1E8/4/frequency));
	   cmd = cmd + 	decToHex(step,8);   // amplitude
       cmd = cmd + 	decToHex(ampC,8);   // amplitude
       cmd = cmd + 	decToHex(offC,8);  // offset   
	} else if (curveTyp == 2) {  // Pulse
	   cmd = "T"; // triangle 
	   start = Math.trunc(maxC / maxV * (off-amp));  // start voltage to code
	   stop = Math.trunc(maxC / maxV * (off+amp));   // stop voltage to code
	   if (start < 0) start = 0;                     // no negative code
	   if (stop > maxC) stop = maxC;                 // stop limited by maximum code
	   step = stop - start;                          // adjust step to difference
	   repeat = Math.trunc(1 / frequency / 2 * 1E8);    // 1E8 fFPGA 
       cmd = cmd + 	decToHex(start,4);   
       cmd = cmd + 	decToHex(stop,4);  // stop =start DC   
       cmd = cmd + 	decToHex(step,4);     
       cmd = cmd +  decToHex(repeat,8);  // frequency
   	} else if (curveTyp == 3) {  // Triangle 
	   var repMax = 64;          // When does step change from 1 to another number
	   cmd = "T"; // triangle 
	   start = Math.trunc(maxC / maxV * (off-amp));
	   stop = Math.trunc(maxC / maxV * (off+amp));
	   if (start < 0) start = 0;
	   if (stop > maxC) stop = maxC;
	   repeat = 1 / frequency / (stop-start) / 2 / 10E-9;    // 1E8 fFPGA 
	   // alert(repeat);
	   if (repeat >= repMax) { 
	      repeat = Math.trunc(repeat); 
	      step = 1;
	   } else {	   
	      step = Math.trunc(repMax / repeat);
		  stop = Math.trunc((stop-start)/step)*step + start;
		  repeat = repMax;
	   }	  
	   cmd = cmd + 	decToHex(start,4);   
       cmd = cmd + 	decToHex(stop,4);  // stop =start DC   
       cmd = cmd + 	decToHex(step,4);     
       cmd = cmd +  decToHex(repeat,8);  // frequency
	} else if (curveTyp == 4) {  // Stair   
	   cmd = "T"; // triangle 
	   start = Math.trunc(maxC / maxV * (off-amp));
	   stop = Math.trunc(maxC / maxV * (off+amp));
	   if (start < 0) start = 0;
	   if (stop > maxC) stop = maxC;
	   repeat = Math.trunc(1 / frequency / 2 / 10E-9 / 5);    // 1E8 fFPGA 
       if (repeat == 0) { 
	      repeat = 1;      // ??	   
	   } else {	   
	      step = Math.trunc((stop-start)/5);
		  stop = Math.trunc((stop-start)/step)*step + start;
	   }	  
	   cmd = cmd + 	decToHex(start,4);   
       cmd = cmd + 	decToHex(stop,4);  // stop =start DC   
       cmd = cmd + 	decToHex(step,4);     
       cmd = cmd +  decToHex(repeat,8);  // frequency
	}
	document.getElementById("cmd").innerHTML = cmd;
}

function plotAWG() {
  // curveTyp  global variable 0 DC, 1 Sine, 2 rect, 3 Triangle 
  var xStart, xStop, xStep;
  var yAmp, yOff; 
  
  xStart = 0;
  xStop = 1/unitToValue(document.getElementById("frequencyVal").value);
  xStep = (xStop - xStart)/aGrN;
  yAmp = unitToValue(document.getElementById("amplitudeVal").value);
  yOff = unitToValue(document.getElementById("offset1Val").value);
  
  for (var i = 0; i < aGrN; i++) {		
	aXY[i] = i*xStep;
	if (curveTyp == 0) {
	   aXY[i+aGrN] = yOff;
	} else if (curveTyp == 1) {   
	   aXY[i+aGrN] = yOff + yAmp * Math.sin(i / aGrN * 2 * Math.PI);
	} else if (curveTyp == 2) {   
	   if (i < aGrN/2) {
	     aXY[i+aGrN] = yOff + yAmp;
	   } else {
	     aXY[i+aGrN] = yOff - yAmp;
	   }
	} else if (curveTyp == 3){  // Triangle
	   if (i < aGrN/4) {
	     aXY[i+aGrN] = yOff + yAmp * i * 4 / aGrN;
	   } else if (i < 3/4*aGrN) {
	     aXY[i+aGrN] = yOff + yAmp - yAmp * (i - aGrN / 4) * 4 / aGrN;
       } else {
	     aXY[i+aGrN] = yOff - yAmp + yAmp * (i - 3/4 * aGrN) * 4 / aGrN;
	   }
	} else {  // Stair
	   if (i < aGrN/10) {
	     aXY[i+aGrN] = yOff - yAmp;
	   } else if (i < 2/10*aGrN) {
	     aXY[i+aGrN] = yOff - yAmp * 3 / 5;
       } else if (i < 3/10*aGrN) {
	     aXY[i+aGrN] = yOff - yAmp * 1 / 5;
       } else if (i < 4/10*aGrN) {
	     aXY[i+aGrN] = yOff + yAmp * 1 / 5;
	   } else if (i < 5/10*aGrN) {
	     aXY[i+aGrN] = yOff + yAmp * 3 / 5;
	   } else if (i < 6/10*aGrN) {
	     aXY[i+aGrN] = yOff + yAmp;
	   } else if (i < 7/10*aGrN) {
	     aXY[i+aGrN] = yOff + yAmp * 3/ 5;
	   } else if (i < 8/10*aGrN) {
	     aXY[i+aGrN] = yOff + yAmp * 1/5;
	   } else if (i < 9/10*aGrN) {
	     aXY[i+aGrN] = yOff - yAmp * 1/5;
	   } else {
	     aXY[i+aGrN] = yOff - yAmp * 3/5;
	   }
    }	
  }
  ScatterPlot("Ausgangssignal","Signal",aXY,aGrN,
		      "time","lin","auto",
			  "Amplitude","lin","auto","Fine");
   genCmdAWG();
   if (aState=="Run") {
	sendCmd();
   }
}

// window.addEventListener("load",Inputsignal ());

//----------------------------------------------------------------------------------//
//-------------------- Oscilloscope    ---------------------------------------------//
//----------------------------------------------------------------------------------//
var mouseX = 0;

var channels = new Array();
			  
// creates HTML entries for C1, C2, C3, C4, M1
function createChannel(baseId, checked, index) {
   var sel = 1;
	var objTxt  ='<input type="checkbox" id="c' + baseId +'" value="value" ' + checked 
	            + ' onclick="toggleCheck(' + "'" + baseId + "'" + ',' + index + ')">';
	   objTxt += baseId + ' Unit:'; 
	   objTxt += '<select id="unit' + baseId +'" >';
	   // <option value="W" onclick="changeUnit('AWG1','')">W</option>
       objTxt += '<option value="count" onclick="changeUnit(' +"'" + baseId + "',''" + ')">Count</option>';
       objTxt += '<option value="V" selected onclick="changeUnit(' + "'" + baseId + "','V'" +')">V</option>';
       objTxt += '<option value="A" onclick="changeUnit(' + "'" + baseId + "','A'" + ')">A</option>';
       objTxt += '<option value="O" onclick="changeUnit(' + "'" + baseId + "','&Omega;'" + ')">&Omega;</option>';
       objTxt += '<option value="W" onclick="changeUnit(' + "'" + baseId + "','W'" + ')">W</option>';
     objTxt += '</select><br>';
	if (checked == "checked") objTxt += '<table id="tab' + baseId +'" style="display:block"><tr><td>'
	else { 
	  objTxt += '<table id="tab' + baseId +'" style="display:none"><tr><td>';
	  sel = 0;
	}  
	   objTxt += 'Offset: </td><td><input type="text" value="0 V" size="5" id="off' + baseId +'Val"></td><td>' 
	   objTxt += '<img id="off' + baseId +'CT" style="display:block" src="ImagesS/SelectListA.png" width="16" height="16" onclick="">';
       objTxt += '</td></tr>';
	   objTxt += ' <tr><td>Range: </td><td><input type="text" value="1 V/div" size="5" id="range' + baseId + 'Val"></td><td>'; 
		objTxt += '  <img id="range' + baseId +'CT" style="display:block" src="ImagesS/SelectListA.png" width="16" height="16" onclick="">';
        objTxt += '  </td></tr>';
		objTxt += '  </table>';
	document.getElementById(baseId).innerHTML = objTxt;	  
    var objChan = {
	           name: baseId,
               selected: sel,
			   unit: "V",
			   offset: 0,
			   range: 1,
			   factor: 1,
			   offScale: 0,
			   min: 0,
			   max: 0,
			   amplitude: 0,
			   average: 0,
			   frequency: 0,
			   period: 0
              } 
	channels.push(objChan);
}		  

// Claculate min, max, amplitude, average, frequency and period for channels. 
function chanStats() {
  for (var i = 0; i < channels.length; i++) { // all channels
     var min = dataOSC2[i*dataMax/2];
     var max = min;
	 var avg = min;
     for (var i1 = 0; i1 < dataMax/2; i1++) {
       var point = dataOSC2[i*dataMax/2 + i1]; 	   
	   if ( point < min) min = point; 
	   if ( point > max) max = point; 
	   avg = avg + point;
     }
	 channels[i].min = min;
	 channels[i].max = max;
 	 avg = avg/dataMax*2;
	 channels[i].average = avg;
     channels[i].amplitude = (max - min)/2;
	 // period and frequency
	 var t = new Array;
	 for (var i1 = 1; i1 < dataMax/2; i1++) {
       var point1 = dataOSC2[i*dataMax/2 + i1]; 	   
	   var point2 = dataOSC2[i*dataMax/2 + i1 - 1]; 	   
	   var point3 = point1;
	   if (point1 > point2) { point1 = point2; point2 = point3; }
       if ((point1 <=avg) && (point2>=avg)) {
	      t.push(i1);
       }	   
     }
	 // Differences between t(i) half period
	 var tx = new Array;
	 for (var i1 = 1; i1 < t.length; i1++) {
	    tx.push(t[i1]-t[i1-1]); 
	 }
	 var periodAvg = 0;
	 for (var i1 = 1; i1 < tx.length; i1++) {
	    periodAvg += (t[i1]-t[i1-1]);  
	 }
	 periodAvg = periodAvg / (tx.length-1) * (dataOSC2[1] - dataOSC2[0]) * 2;
	 channels[i].period = periodAvg;
	 channels[i].frequency = 1/periodAvg;
  }
  var chanTxt = "Measurement <br>\n<table>";
  for (var i = 1; i < channels.length; i++) { // all channels
   if  (channels[i].selected == 1) {
    chanTxt += "<tr><td class='bo" + i +"'>"; 
	chanTxt += channels[i].name + " Min: " + valueToUnit(channels[i].min) + channels[i].unit + "<br>"
    chanTxt += channels[i].name + " Max: " + valueToUnit(channels[i].max) + channels[i].unit + "<br>"
    chanTxt += channels[i].name + " Avg: " + valueToUnit(channels[i].average) + channels[i].unit + "<br>"
    chanTxt += channels[i].name + " Amp: " + valueToUnit(channels[i].amplitude) + channels[i].unit + "<br>"
    chanTxt += channels[i].name + " T: " + valueToUnit(channels[i].period) + "s <br>"
  	chanTxt += channels[i].name + " f: " + valueToUnit(channels[i].frequency) + "Hz <br>"
	chanTxt += "</td></tr>";
   }	
  }
	chanTxt += "</table>";
  document.getElementById("measureOSC").innerHTML = chanTxt;
}

function changeUnit(id,unit) {
  for (var i=0; i < channels.length; i++) {
     if (channels[i].name == id) {
	    channels[i].unit = unit;
		// ToDo: change offset, range list !!
	 }
  }
}

function toggleCheck(id, index){
  var display = document.getElementById("tab"+id).style.display;
  if (display == "block") { 
    document.getElementById("tab"+id).style.display = "none";
    channels[index].selected = 0;
  } else {
    document.getElementById("tab"+id).style.display = "block";
    channels[index].selected = 1;
  }
  updatePlot();
  chanStats()
}

var objChan = { name: "time", selected: 1, unit: "s", offset: 0, range: 0.3E-3, factor : 1, offScale: 0 } 
channels.push(objChan);
objChan = { name: "AWG1", selected: 1, unit: "V", offset: 0, range: 1, factor : 1, offScale: 0 } 
channels.push(objChan);

createChannel("C1", "checked",2);
createChannel("C2", "",3);
createChannel("C3", "",4);
createChannel("C4", "",5);
createChannel("M1", "",6);

var colorstr=['#0000ff','#00a000','#ff0000','#ff00ff','#007070','#700070','#ffff00','#00ffff']

function drawGrid() {
   var canv_obj=document.getElementById("OSC");
   
   if (!canv_obj) { alert('Error: I cannot find the canvas element!'); return; }
   if (!canv_obj.getContext) {alert('Error: no canvas.getContext!');return;}
    // Get the 2D canvas context.
   var chart_context = canv_obj.getContext('2d');
   if (!chart_context) { alert('Error: failed to getContext!'); return; }
   chart_context.clearRect(0,0,canv_obj.width,canv_obj.height);
   // Grid
   // 20% are for labels
   var xll = 0.18 * canv_obj.width;
   var xur = (1 -0.18) * canv_obj.width;
   var yll = 0.1 * canv_obj.height;
   var yur = (1 - 0.1)*canv_obj.height;
   chart_context.strokeStyle = "#000000"; // black
   chart_context.beginPath();
   chart_context.rect(xll,yll,xur-xll,yur-yll);
   chart_context.stroke();
   var xstep = Math.round((xur - xll)/10);
   var ystep = Math.round((yur - yll)/10);
   chart_context.lineWidth = 1;
   chart_context.setLineDash([1, 1]);  // dashes are 5px and spaces are 3px
   for (var i = 1; i < 10; i++){  // 10 horizontal
      chart_context.beginPath();
      chart_context.moveTo(xll, yll + i * ystep);
      chart_context.lineTo(xur, yll + i * ystep);
      chart_context.stroke();     
   }   
   for (var i = 1; i < 10; i++){  // 10 horizontal
      chart_context.beginPath();
      chart_context.moveTo(xll + i * xstep, yll);
      chart_context.lineTo(xll + i * xstep, yur);
      chart_context.stroke();     
   }   
   // small marks
    chart_context.setLineDash([]);
   for (var i = 1; i < 100; i++){  // 10 horizontal
      chart_context.beginPath();
      chart_context.moveTo(xll, Math.round((yur - yll)/100 * i + yll));
      chart_context.lineTo(xll + 4, Math.round((yur -yll)/100 * i + yll));
      chart_context.stroke();     
    }      
}

window.addEventListener("load",drawGrid());

//  
 var currCon = 0;      // current Position of acquisition there the curve starts and ends
 var dataMax = 512;
 var dataOSC1 =[];    // all sorted data
 var dataOSC2 =[];    // final oscilloscope data extracted with trigger 
 var xAxisIndex = 0;
 var activeIndex = 1;
 
var mouseStartX = 0;
var mouseStartY = 0;
var mouseCurrX = 0;
var mouseCurrY = 0;
var offsetStart;
var widthX, heightY;
var lines = new Array("pos","offAWG1","offC1","offC2","offC3","offC4","offM1");

function listenCanvas(event) { // event listener for canvas How to add?
      var canv_obj=document.getElementById("OSC");
      var rect = canv_obj.getBoundingClientRect();
      // mouse and touchscreen
      if (mouseX == 1) {   // x - axis right left canvas area? 
        mouseCurrX = Math.round(event.clientX - rect.left);
        mouseCurrY = Math.round(event.clientY - rect.top);
	    channels[xAxisIndex].offset = offsetStart - (mouseCurrX - mouseStartX) / widthX * 10 * channels[xAxisIndex].range;
        document.getElementById("mouse").innerHTML = "Move " + mouseCurrX + "," + mouseCurrY + "," + mouseX;		
	    updatePlot();
		document.getElementById(lines[xAxisIndex]+"Val").value = valueToUnit(channels[xAxisIndex].offset) + channels[xAxisIndex].unit;
		// update range entry!!
      } else if 	(mouseX == 2) { // y axis up down canvas area?
        mouseCurrX = Math.round(event.clientX - rect.left);
        mouseCurrY = Math.round(event.clientY - rect.top);
	    channels[activeIndex].offset = offsetStart - (mouseCurrY - mouseStartY) / heightY * 10 * channels[activeIndex].range;
        document.getElementById("mouse").innerHTML = "Move " + mouseCurrX + "," + mouseCurrY + "," + mouseX;		
	    updatePlot();
		document.getElementById(lines[activeIndex]+"Val").value = valueToUnit(channels[activeIndex].offset) + channels[activeIndex].unit;
      }
      
      // x1, x2 cursor vertical column canvas area?
      // y1, y2 cursor row canvas area?
      // marker for channels and trigger canvas area?
}

function addCanvasEvent(){
   var canv_obj=document.getElementById("OSC");
   var xll=0.18*canv_obj.width;
   var xur= (0.18+perSizeX)*canv_obj.width;
   widthX = xur - xll;
   var yll=0.1*canv_obj.height;
   var yur=(0.1+perSizeY)*canv_obj.height;
   heightY = yur - yll;
   var xb = canv_obj.width*0.05;
   var yb = canv_obj.height*0.05;
	
   canv_obj.addEventListener('mouseup', function(event){ mouseX = 0;}, false);  // attach event listener to canvas
   canv_obj.addEventListener('mousedown', function(event){ 
        var canv_obj=document.getElementById("OSC");
		var rect = canv_obj.getBoundingClientRect();
		mouseStartX = Math.round(event.clientX - rect.left);
		mouseStartY = Math.round(event.clientY - rect.top);
		// x-axis offset
		if   ((mouseStartX < xur) && (mouseStartX > xll)
          && (mouseStartY < yur + yb) && (mouseStartY > yur)) {
          mouseX = 1;
          offsetStart = channels[xAxisIndex].offset;		  
		}  
		// y-axis
		if   ((mouseStartX < xll) && (mouseStartX > xll - xb)
          && (mouseStartY < yur) && (mouseStartY > yll)) {
          mouseX = 2; 
          offsetStart = channels[activeIndex].offset;		  
		}  
        // x1,x2,y1,y2 cursor
        // awg1, c1, c2,c3,c4, xaxis, level triangle 
        document.getElementById("mouse").innerHTML = "Down " + mouseStartX + "," + mouseStartY + "," + mouseX;		
	  }, false
   );  // attach event listener to canvas
   canv_obj.addEventListener('mousemove', listenCanvas, false);  // attach event listener to canvas
   // touchstart, touchmove, touchend   
   // alert("Events registered");
}

window.addEventListener("load",addCanvasEvent());

function activeChan(x) {
  activeIndex = x;
  if (channels[x].selected == 0) { channels[x].selected = 1; } // make active
  updatePlot();
}

function changeXAxis() {
   xAxisIndex = document.getElementById("xyAxis").value; 
   // if (channels[xAxisIndex].selected == 0) { channels[xAxisIndex].selected = 1; } // make active
   updatePlot();
}

function updatePlot(){
                 ScatterPlotO("OSC","Oszilloskop",dataOSC2,dataMax/2,
		                     "time","lin","Minmax",
			                 "Amplitude","lin","auto","Grid",
							 xAxisIndex, activeIndex, channels);

}

function generateData() {
    var dataMax2= dataMax/2;
	for (var i = 0; i < dataMax/2; i++) {
			        dataOSC2[i] = (i - dataMax/4) / 1E6 * 8 ; // maximum acquistion rate trigger center
			        dataOSC2[i + dataMax2] = i / 256 * 3.3;
			        dataOSC2[i + 2 * dataMax2] = 3.3 * (1+Math.sin(i*2*Math.PI/dataMax2));
			        dataOSC2[i + 3 * dataMax2] = 1.7 * (1+Math.sin(i*2*Math.PI/dataMax2));
			        dataOSC2[i + 4 * dataMax2] = 1.0 * (1+Math.sin(4*i*2*Math.PI/dataMax2));
			        dataOSC2[i + 5 * dataMax2] = 0.5 * (1+Math.sin(3*i*2*Math.PI/dataMax2));
	}
                 updatePlot();
			    let now = new Date();
                let nowTxt = now.getFullYear() + "/" + (now.getMonth()+1)
                           + "/" + now.getDate() + " " + now.getHours()
						   + ":" + now.getMinutes() + ":" + now.getSeconds()+ "." + now.getMilliseconds();			
				// 1 Msps 8 samples per point 1E6/8						
				document.getElementById("statusOSC").innerHTML = "Data generated at " + nowTxt + " " + dataMax2 
				   + " samples" ;
     chanStats();
}

//----------------------------------------------------------------------------------//
//-------------------- NodeJS commands ---------------------------------------------//
//----------------------------------------------------------------------------------//

        var socket = io.connect();
 
 
        socket.on('newData', function (data) {                  // get from server LSB..MSB
            var rVal="";
			var dataX = "";
			var dataY = data.value;
			  for (var i = dataY.length - 1; i >= 0 ; i--) { // bring in right order addr 4,3,2,1,0 awg,c4,c3,c2,c1
			      dataX += dataY.substring(i,i+1);
			  }
			if  (dataY[0] == "U") { // (dataIndex == 0) {
			   var j = 4;                // current acquisition position stored first 
			   currCon = // hexToDec(dataX.substring(1+4*4,5+4*4))
			             // + "," + hexToDec(dataX.substring(1+3*4,5+3*4))
						 // + "," + 
						 hexToDec(dataX.substring(1+2*4,5+2*4))
						 // + "," + hexToDec(dataX.substring(1+1*4,5+1*4))
						 // + "," + hexToDec(dataX.substring(1,5));
			   // currCon = dataX + "<br>\n"+ currCon +";<br>\n" 
			      //     + (hexToDec(dataX.substring(1+2*4,5+2*4))) +";<br>\n"; 		 
			   dataIndex = 1;
			   currCon = currCon + 1;
            } else {			
			  dataOSC[dataIndex - 1] = dataIndex - 1;
			  for (var i = 0; i < 5; i++) {
			     var sVal = dataX.substring(1+i*4,5+i*4);  // indexStart, indexEnd	
                 // alert(sVal);			   
			     rVal += sVal +"," + hexToDec(sVal) + ","; // ;
				 // store scaled data
				 dataOSC[dataIndex - 1 + dataMax * (i+1)] = Math.trunc(hexToDec(sVal)/256); // store data in array
			  }
			  document.getElementById("data").innerHTML = currCon + "," + dataIndex + "," + dataY.length + "," + 
			    dataX.length + "," + dataX + ": " + rVal;
			  dataIndex += 1;                                   // next set
	        }		
			  dataOSC1 = [];
			  if (dataIndex == dataMax + 1) {
			     // sort data
			     for (var i = 0; i < dataMax; i++) {
			       if (i + currCon < dataMax) {
				    dataOSC1[i] = i;
				    dataOSC1[i + dataMax] = dataOSC[i + currCon + dataMax];
				    dataOSC1[i + 2 * dataMax] = dataOSC[i + currCon + 2 * dataMax];
				    dataOSC1[i + 3 * dataMax] = dataOSC[i + currCon + 3 * dataMax];
				    dataOSC1[i + 4 * dataMax] = dataOSC[i + currCon + 4 * dataMax];
				    dataOSC1[i + 5 * dataMax] = dataOSC[i + currCon + 5 * dataMax];
				   } else {
				     dataOSC1[i] = i;
				     dataOSC1[i + dataMax] = dataOSC[i + currCon ];
				     dataOSC1[i + 2 * dataMax] = dataOSC[i + currCon + 1 * dataMax];
				     dataOSC1[i + 3 * dataMax] = dataOSC[i + currCon + 2 * dataMax];
				     dataOSC1[i + 4 * dataMax] = dataOSC[i + currCon + 3 * dataMax];
				     dataOSC1[i + 5 * dataMax] = dataOSC[i + currCon + 4 * dataMax];
                   }				   
				 }
				 // look for trigger
				 var trg = parseInt(document.getElementById("trgSrc").value); // Channel
				 var trgEdge = parseInt(document.getElementById("trgEdge").value);
				 var trgLevel = 100;
				 var trgPos = -1;
				 for (var i = Math.round(dataMax/4); i < 3*dataMax/4; i++) {
			       if ((dataOSC1[i + dataMax * trg] > dataOSC1[i-1+ dataMax * trg]) // rising
                      && (dataOSC1[i + dataMax * trg] >= trgLevel)
                      && (trgLevel >= dataOSC1[i-1+ dataMax * trg]) && (trgEdge==1))
                       trgPos = i; 					  
			       if ((dataOSC1[i + dataMax * trg] < dataOSC1[i-1+ dataMax * trg]) // falling
                      && (dataOSC1[i + dataMax * trg] <= trgLevel)
                      && (trgLevel <= dataOSC1[i-1+ dataMax * trg]) && (trgEdge==2))
                       trgPos = i; 					  
				 }
				 // alert(trgPos);
				 // transfer triggered data
				 if (trgPos < 0) trgPos = Math.round(dataMax/2);
				 trgPos = trgPos - Math.round(dataMax/4);
				 var dataMax2 = Math.round(dataMax/2);
				 for (var i = 0; i < dataMax/2; i++) {
			        dataOSC2[i] = i;
			        dataOSC2[i + dataMax2] = dataOSC1[ i + trgPos + dataMax];
			        dataOSC2[i + 2 * dataMax2] = dataOSC1[ i + trgPos + 2 * dataMax];
			        dataOSC2[i + 3 * dataMax2] = dataOSC1[ i + trgPos + 3 * dataMax];
			        dataOSC2[i + 4 * dataMax2] = dataOSC1[ i + trgPos + 4 * dataMax];
			        dataOSC2[i + 5 * dataMax2] = dataOSC1[ i + trgPos + 5 * dataMax];
				 }
				 // ready to plot
                 // ScatterPlot("OSC","Oszilloskop",dataOSC2,dataMax2,
		         //            "time","lin","Minmax",
			     //            "Amplitude","lin","auto","Fine");
				 updatePlot();
				      chanStats();

				let now = new Date();
                let nowTxt = now.getFullYear() + "/" + (now.getMonth()+1)
                           + "/" + now.getDate() + " " + now.getHours()
						   + ":" + now.getMinutes() + ":" + now.getSeconds()+ "." + now.getMilliseconds();			
				var triggered = trgPos < 0 ? "not triggered":"triggered";
				// 1 Msps 8 samples per point 1E6/8						
				document.getElementById("statusOSC").innerHTML = triggered + " " + nowTxt + " " + dataMax2 + " samples at " 
				   + valueToUnit(1E6/8) + "Hz/" + valueToUnit(8/1E6) + "s";
				dataIndex = 0;	
				busyOsc = 0;
			   }
        });
        
        function sendCmd()   // filename fName send to server
        {
            var cmd = document.getElementById("cmd").innerHTML ;
			// if (cmd="U") alert("Tx");
            socket.emit('cmd', { value: cmd });
        }
		
        function sendCmdC()   // filename fName send to server
        {
            var cmd = document.getElementById("cmdTxt").innerHTML ;
			// if (cmd="U") alert("Tx");
            socket.emit('cmd', { value: cmd });
			document.getElementById("lCmd").innerHTML = cmd;
        }

		// Will pop up regularly
		// socket.on("connect_error", (error) => {
           // ...
		//   alert("connect error");
        // });
	
</script>
	
	
	</body>
	</html>